<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene to Music Synthesizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .note, .amino-acid {
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .note.playing {
            background-color: #4f46e5;
            color: white;
        }
        .amino-acid.playing {
            background-color: #059669; /* Emerald-600 */
            color: white;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style for the volume slider */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
        #progress-bar {
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- CHANGED: max-w-3xl to max-w-6xl for wider desktop view -->
    <div class="bg-white w-full max-w-6xl mx-auto p-6 sm:p-8 rounded-2xl shadow-lg space-y-6">
        <!-- Header Section -->
        <div class="flex flex-col items-center text-center">
            <div class="h-16 w-16 rounded-2xl overflow-hidden shadow-lg border border-slate-100 bg-white mb-4">
                 <img 
                    src="logo.jpg" 
                    alt="Logo"
                    class="h-full w-full object-cover"
                    onerror="this.src='https://ui-avatars.com/api/?name=Gene+Music&background=4f46e5&color=fff&size=128'"
                 />
            </div>
            
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Gene to Music</h1>
            <p class="text-slate-500 mt-2">Transform DNA codons into musical pieces with rhythm.</p>
            
            <!-- CRÉDITOS Y ENLACE -->
            <p class="text-xs text-slate-400 mt-3 font-mono border-t border-slate-100 pt-3 w-full max-w-xs mx-auto">
                Created by Carlos David <a href="https://cdcruzher.github.io/cdcruzher/" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:text-indigo-600 font-semibold transition-colors">@cdcruzher</a>
            </p>
        </div>
        
        <!-- User Name Input -->
        <div>
            <label for="user-name" class="block text-sm font-medium text-slate-700 mb-2">Your Name (for the PDF report):</label>
            <input type="text" id="user-name" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Enter your name">
        </div>

        <!-- Manual Input Section -->
        <div>
            <label for="gene-sequence" class="block text-sm font-medium text-slate-700 mb-2">Enter a DNA sequence here (example: Human FOXM1 Gene):</label>
            <textarea id="gene-sequence" rows="5" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out font-mono text-sm" placeholder="e.g., ATGCCGCTAGTT...">ATGGCGTCGGCCGCGGGCTCGGCGCTGCTGGCCCGGCTCGGCCCCAGCAGCTCGGGGCCGCCCTCTCCGCACCCCCGGAGCCGCCTCCGCGCCGCCCGGCGGAGGCGCGGGAGCGGCGGCGGCGGCGGCGGCCGGCGGCGGCTCAGGTCCGCGGGCGGCGGCGCGGGCCTCTTCCTCCACCACGTCGTCCGCGTCCCCGCCGCCGGCTCCGGCTCCTCCTACCACTTCACCTTCCCCGGCCTCCTCCCCGCCGCCGGGCCGCCCGGCTGCGGGCGGCGGCCGCCGCCGCCTCCCCCTGCCGCCGGCCGCCCGGCTGCGGGCGGCGGCCGCCGCCGCCTCCCCCTGCCGCCGGCCGCCCGGCTGCGGGCGGCGGCCGCCGCCGCCTCCCCCTGCCGCCGGCCTCCTCCCCGCCGCCGGGCCGCCCGGCTGCGGGCGGCGGCCGCCGCCGCCTCCCCCTG</textarea>
            <p class="text-xs text-slate-500 mt-2 text-center">Or, <a href="https://www.ncbi.nlm.nih.gov/nuccore/" target="_blank" class="text-indigo-600 hover:underline">find a different sequence at NCBI's Nucleotide database</a>.</p>
        </div>
        
        <!-- Musical Scale Controls -->
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg space-y-4">
             <h4 class="font-semibold text-slate-800">Musical Filter Options</h4>
             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label for="scale-type" class="block text-sm font-medium text-slate-700 mb-2">Scale Type</label>
                    <select id="scale-type" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="chromatic">Chromatic (All Notes)</option>
                        <option value="major">Major</option>
                        <option value="minor">Minor</option>
                        <option value="harmonic_minor">Harmonic Minor</option>
                        <option value="pentatonic_major">Pentatonic Major</option>
                        <option value="pentatonic_minor">Pentatonic Minor</option>
                        <option value="blues">Blues</option>
                        <option value="dorian">Dorian</option>
                        <option value="phrygian">Phrygian</option>
                        <option value="lydian">Lydian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="locrian">Locrian</option>
                        <option value="whole_tone">Whole Tone</option>
                    </select>
                </div>
                <div>
                    <label for="root-note" class="block text-sm font-medium text-slate-700 mb-2">Root Note</label>
                    <select id="root-note" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" disabled>
                        <option>C</option> <option>C#</option> <option>D</option> <option>D#</option> <option>E</option> <option>F</option> <option>F#</option> <option>G</option> <option>G#</option> <option>A</option> <option>A#</option> <option>B</option>
                    </select>
                </div>
                <div>
                    <label for="music-genre" class="block text-sm font-medium text-slate-700 mb-2">Music Genre</label>
                    <select id="music-genre" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="default">Default (Even)</option>
                        <option value="classical">Classical (Waltz)</option>
                        <option value="jazz">Jazz (Swing)</option>
                        <option value="rock">Rock</option>
                        <option value="funk">Funk</option>
                        <option value="bossa_nova">Bossa Nova</option>
                        <option value="electronic">Electronic (Trance)</option>
                        <option value="ambient">Ambient</option>
                        <option value="minimalist">Minimalist</option>
                    </select>
                </div>
             </div>
             <div>
                <label for="drum-volume" class="block text-sm font-medium text-slate-700 mb-2">Percussion Volume</label>
                <input type="range" id="drum-volume" min="-30" max="10" value="-10" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
             </div>
        </div>

        <!-- Control Buttons -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <button id="transform-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform active:scale-95 shadow-md">
                Transform & Filter
            </button>
            <button id="play-btn" class="w-full bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-600 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                Play
            </button>
            <button id="stop-btn" class="w-full bg-red-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-600 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                Stop
            </button>
        </div>
        
        <!-- Download Buttons -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-2">
             <button id="download-audio-btn" class="w-full bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-sky-700 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                Download WEBM Audio
            </button>
            <button id="download-pdf-btn" class="w-full bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-700 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                Download PDF Report
            </button>
            <button id="convert-audio-btn" class="w-full bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-slate-700 disabled:bg-slate-400 disabled:cursor-not-allowed" title="Convert your downloaded file to MP3 or other formats">
                Convert to MP3 (external)
            </button>
        </div>
        
        <!-- Progress Bar & Status -->
        <div id="progress-container" class="hidden w-full bg-slate-200 rounded-full h-2.5 mt-4">
            <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <div id="progress-text" class="text-center text-sm text-slate-500 h-5"></div>
        <div id="status" class="text-center text-slate-500 h-5"></div>

        <!-- Output Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Amino Acid Sequence:</h3>
                <div id="amino-acid-output" class="w-full h-48 bg-slate-50 border border-slate-200 rounded-lg p-4 overflow-y-auto text-center flex flex-wrap gap-2 justify-center content-start">
                    <span class="text-slate-400">Amino acids will appear here...</span>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Generated Musical Notes:</h3>
                <div id="notes-output" class="w-full h-48 bg-slate-50 border border-slate-200 rounded-lg p-4 overflow-y-auto text-center flex flex-wrap gap-2 justify-center content-start">
                    <span class="text-slate-400">Notes will appear here...</span>
                </div>
            </div>
        </div>

        <!-- SECCIÓN DE DONACIÓN AGREGADA -->
        <div class="mt-8 pt-6 border-t border-slate-100 flex flex-col items-center">
            <p class="text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Support the Project</p>
            <a href="https://www.paypal.com/donate/?business=6EN68NHUTM2KQ&no_recurring=0&item_name=Thanks+for+your+support+Amigo%21&currency_code=USD" target="_blank" rel="noopener noreferrer" class="block w-32 h-32 bg-white p-2 rounded-xl border border-slate-100 hover:shadow-md hover:scale-105 transition-all cursor-pointer" title="Scan or Click to Donate">
                <img 
                    src="qrcode.jpg" 
                    alt="Donate QR Code"
                    class="w-full h-full object-contain"
                    onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https%3A%2F%2Fwww.paypal.com%2Fdonate%2F%3Fbusiness%3D6EN68NHUTM2KQ%26no_recurring%3D0%26item_name%3DThanks%2Bfor%2Byour%2Bsupport%2BAmigo%21%26currency_code%3DUSD'"
                />
            </a>
            <p class="text-[10px] text-slate-400 mt-2 text-center">Scan or click the QR code to donate via PayPal</p>
        </div>

    </div>
    
    <!-- Modal for conversion confirmation -->
    <div id="convert-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-xl">
            <h3 class="text-lg font-bold text-slate-900">Confirmation</h3>
            <p class="mt-2 text-sm text-slate-600">Before you continue, make sure you have saved the <strong>gene_music.webm</strong> file to your computer. Do you want to open the conversion site now?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Continue</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const geneSequenceInput = document.getElementById('gene-sequence');
            const transformBtn = document.getElementById('transform-btn');
            const playBtn = document.getElementById('play-btn');
            const stopBtn = document.getElementById('stop-btn');
            const downloadAudioBtn = document.getElementById('download-audio-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const convertAudioBtn = document.getElementById('convert-audio-btn');
            const notesOutput = document.getElementById('notes-output');
            const aminoAcidOutput = document.getElementById('amino-acid-output');
            const statusDiv = document.getElementById('status');
            const scaleTypeSelect = document.getElementById('scale-type');
            const rootNoteSelect = document.getElementById('root-note');
            const genreSelect = document.getElementById('music-genre');
            const drumVolumeSlider = document.getElementById('drum-volume');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const convertModal = document.getElementById('convert-modal');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const userNameInput = document.getElementById('user-name');

            let synth, kick, snare, hihat;
            let noteSequence = [];
            let aminoAcidSequence = [];
            let melodyPart, drumLoop;
            let drumVolume = new Tone.Volume(-10).toDestination();
            
            const { jsPDF } = window.jspdf;

            const codonNoteMap = {
                'GCT': 'C4', 'GCC': 'C4', 'GCA': 'C4', 'GCG': 'C4', 'CGT': 'C#4', 'CGC': 'C#4', 'CGA': 'C#4', 'CGG': 'C#4', 'AGA': 'C#4', 'AGG': 'C#4', 'AAT': 'D4', 'AAC': 'D4', 'GAT': 'D#4', 'GAC': 'D#4', 'TGT': 'E4', 'TGC': 'E4', 'GAA': 'F4', 'GAG': 'F4', 'CAA': 'F#4', 'CAG': 'F#4', 'GGT': 'G4', 'GGC': 'G4', 'GGA': 'G4', 'GGG': 'G4', 'CAT': 'G#4', 'CAC': 'G#4', 'ATT': 'A4', 'ATC': 'A4', 'ATA': 'A4', 'TTA': 'A#4', 'TTG': 'A#4', 'CTT': 'A#4', 'CTC': 'A#4', 'CTA': 'A#4', 'CTG': 'A#4', 'AAA': 'B4', 'AAG': 'B4', 'ATG': 'C5', 'TTT': 'C#5', 'TTC': 'C#5', 'CCT': 'D5', 'CCC': 'D5', 'CCA': 'D5', 'CCG': 'D5', 'TCT': 'D#5', 'TCC': 'D#5', 'TCA': 'D#5', 'TCG': 'D#5', 'AGT': 'D#5', 'AGC': 'D#5', 'ACT': 'E5', 'ACC': 'E5', 'ACA': 'E5', 'ACG': 'E5', 'TGG': 'F5', 'TAT': 'F#5', 'TAC': 'F#5', 'GTT': 'G5', 'GTC': 'G5', 'GTA': 'G5', 'GTG': 'G5', 'TAA': null, 'TAG': null, 'TGA': null
            };

            const codonAminoAcidMap = {
                'GCT': 'Ala', 'GCC': 'Ala', 'GCA': 'Ala', 'GCG': 'Ala', 'CGT': 'Arg', 'CGC': 'Arg', 'CGA': 'Arg', 'CGG': 'Arg', 'AGA': 'Arg', 'AGG': 'Arg', 'AAT': 'Asn', 'AAC': 'Asn', 'GAT': 'Asp', 'GAC': 'Asp', 'TGT': 'Cys', 'TGC': 'Cys', 'GAA': 'Glu', 'GAG': 'Glu', 'CAA': 'Gln', 'CAG': 'Gln', 'GGT': 'Gly', 'GGC': 'Gly', 'GGA': 'Gly', 'GGG': 'Gly', 'CAT': 'His', 'CAC': 'His', 'ATT': 'Ile', 'ATC': 'Ile', 'ATA': 'Ile', 'TTA': 'Leu', 'TTG': 'Leu', 'CTT': 'Leu', 'CTC': 'Leu', 'CTA': 'Leu', 'CTG': 'Leu', 'AAA': 'Lys', 'AAG': 'Lys', 'ATG': 'Met', 'TTT': 'Phe', 'TTC': 'Phe', 'CCT': 'Pro', 'CCC': 'Pro', 'CCA': 'Pro', 'CCG': 'Pro', 'TCT': 'Ser', 'TCC': 'Ser', 'TCA': 'Ser', 'TCG': 'Ser', 'AGT': 'Ser', 'AGC': 'Ser', 'ACT': 'Thr', 'ACC': 'Thr', 'ACA': 'Thr', 'ACG': 'Thr', 'TGG': 'Trp', 'TAT': 'Tyr', 'TAC': 'Tyr', 'GTT': 'Val', 'GTC': 'Val', 'GTA': 'Val', 'GTG': 'Val', 'TAA': '---', 'TAG': '---', 'TGA': '---'
            };

            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const scaleIntervals = {
                major: [0, 2, 4, 5, 7, 9, 11], 
                minor: [0, 2, 3, 5, 7, 8, 10], 
                harmonic_minor: [0, 2, 3, 5, 7, 8, 11],
                pentatonic_major: [0, 2, 4, 7, 9], 
                pentatonic_minor: [0, 3, 5, 7, 10], 
                blues: [0, 3, 5, 6, 7, 10], 
                dorian: [0, 2, 3, 5, 7, 9, 10], 
                phrygian: [0, 1, 3, 5, 7, 8, 10], 
                lydian: [0, 2, 4, 6, 7, 9, 11],
                mixolydian: [0, 2, 4, 5, 7, 9, 10],
                locrian: [0, 1, 3, 5, 6, 8, 10],
                whole_tone: [0, 2, 4, 6, 8, 10]
            };
            
            const genreStyles = {
                'default': {
                    rhythm: ['8n'],
                    drumPattern: null,
                    synthOptions: { oscillator: { type: 'fmsine' }, envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 1 } }
                },
                'classical': {
                    rhythm: ['4n', '8n', '8n'], 
                    drumPattern: null,
                    synthOptions: { oscillator: { type: 'sine' }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.4, release: 1.4 } }
                },
                'jazz': {
                    rhythm: ['8n.', '16n'],
                    drumPattern: [
                        { time: '0:0:0', note: 'C1' }, { time: '0:0:2', note: 'C2' }, 
                        { time: '0:1:0', note: 'E2' }, { time: '0:1:2', note: 'C2' },
                        { time: '0:2:0', note: 'C1' }, { time: '0:2:2', note: 'C2' },
                        { time: '0:3:0', note: 'E2' }, { time: '0:3:2', note: 'C2' },
                    ],
                    synthOptions: { oscillator: { type: 'fmtriangle', harmonicity: 1.2 }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 0.8 } }
                },
                'rock': {
                    rhythm: ['8n', '8n', '4n'], 
                    drumPattern: [
                        { time: '0:0', note: 'C1' }, { time: '0:1', note: 'C2' },
                        { time: '0:2', note: 'C1' }, { time: '0:3', note: 'C2' },
                    ],
                    synthOptions: {
                        oscillator: { type: 'fatsawtooth', count: 3, detune: 30 },
                        envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.5 }
                    },
                    distortion: 0.8 // Amount of distortion from 0 to 1
                },
                 'funk': {
                    rhythm: ['16n', null, '8n', '16n'], 
                    drumPattern: [
                        { time: '0:0', note: 'C1' }, { time: '0:0:2', note: 'E2' },
                        { time: '0:1', note: 'C2' }, { time: '0:1:2', note: 'E2' },
                        { time: '0:2', note: 'C1' }, { time: '0:2:2', note: 'E2' },
                        { time: '0:3', note: 'C2' }, { time: '0:3:2', note: 'E2' },
                    ],
                    synthOptions: { oscillator: { type: 'fatsawtooth', count: 2 }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.3 } }
                },
                'bossa_nova': {
                    rhythm: ['8n', '16n', null, '16n', '8n'], 
                      drumPattern: [
                        { time: '0:0', note: 'C1' }, { time: '0:0:3', note: 'E2' },
                        { time: '0:1', note: 'C2' }, { time: '0:1:2', note: 'E2' },
                        { time: '0:2', note: 'C1' }, { time: '0:2:2', note: 'E2' },
                        { time: '0:3', note: 'C2' }, { time: '0:3:3', note: 'E2' },
                    ],
                    synthOptions: { oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.6, sustain: 0.1, release: 0.5 } }
                },
                'electronic': {
                    rhythm: ['16n', '16n', '16n', '16n', '8n'], 
                    drumPattern: [
                        { time: '0:0', note: 'C1' }, { time: '0:1', note: 'C1' },
                        { time: '0:2', note: 'C1' }, { time: '0:3', note: 'C1' },
                    ],
                    synthOptions: { oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }
                },
                'ambient': {
                    rhythm: ['1n'], 
                    drumPattern: null,
                    synthOptions: { oscillator: { type: 'amsine', harmonicity: 1.5 }, envelope: { attack: 2, decay: 1, sustain: 0.8, release: 4 } }
                },
                'minimalist': {
                    rhythm: ['8n'], 
                    drumPattern: [{ time: '0:0', note: 'C1' }, { time: '0:2', note: 'C1' }],
                    synthOptions: { oscillator: { type: 'pulse', width: 0.7 }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }
                }
            };
            
            function initializeSynths() {
                if (!kick) {
                    kick = new Tone.MembraneSynth({
                        pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' },
                        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' }
                    }).connect(drumVolume);
                }
                if (!snare) {
                      snare = new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
                    }).connect(drumVolume);
                }
                 if (!hihat) {
                      hihat = new Tone.NoiseSynth({
                        noise: { type: 'brown' },
                        envelope: { attack: 0.001, decay: 0.05, sustain: 0 }
                    }).connect(drumVolume);
                }
            }
            
            drumVolumeSlider.addEventListener('input', (e) => {
                drumVolume.volume.value = e.target.value;
            });
            
            scaleTypeSelect.addEventListener('change', () => {
                rootNoteSelect.disabled = scaleTypeSelect.value === 'chromatic';
            });
            
            transformBtn.addEventListener('click', () => {
                playBtn.disabled = true;
                stopBtn.disabled = true;
                downloadAudioBtn.disabled = true;
                downloadPdfBtn.disabled = true;
                convertAudioBtn.disabled = true;

                const sequence = geneSequenceInput.value;
                if (!sequence) {
                    statusDiv.textContent = "Please enter a DNA sequence.";
                    return;
                }
                
                const cleanedSequence = sequence.replace(/[^ATCG]/g, '').toUpperCase();
                const codons = [];
                for (let i = 0; i <= cleanedSequence.length - 3; i += 3) {
                    codons.push(cleanedSequence.substring(i, i + 3));
                }
                
                const allData = codons.map(codon => ({
                    note: codonNoteMap[codon],
                    amino: codonAminoAcidMap[codon]
                })).filter(item => item.note !== null);
                
                const allNotes = allData.map(item => item.note);
                const allAminoAcids = allData.map(item => item.amino);

                if (allNotes.length === 0) {
                    notesOutput.innerHTML = '<span class="text-slate-400">No valid codons were found.</span>';
                    aminoAcidOutput.innerHTML = '<span class="text-slate-400">No valid codons were found.</span>';
                    statusDiv.textContent = "Transformation failed.";
                    return;
                }
                
                const scaleType = scaleTypeSelect.value;
                let statusMsg = `Generated ${allNotes.length} notes & amino acids.`;

                if (scaleType === 'chromatic') {
                    noteSequence = allNotes;
                    aminoAcidSequence = allAminoAcids;
                } else {
                    const rootNote = rootNoteSelect.value;
                    const allowedNotes = getScaleNotes(rootNote, scaleType);
                    
                    const filteredData = allData.filter(item => allowedNotes.includes(item.note.slice(0, -1)));
                    noteSequence = filteredData.map(item => item.note);
                    aminoAcidSequence = filteredData.map(item => item.amino);

                    statusMsg += ` Filtered to ${noteSequence.length} in the ${rootNote} ${scaleType.replace(/_/g, ' ')} scale.`;
                }

                if (noteSequence.length === 0) {
                      notesOutput.innerHTML = `<span class="text-slate-400">No notes fit the scale.</span>`;
                      aminoAcidOutput.innerHTML = `<span class="text-slate-400">No items fit the scale.</span>`;
                } else {
                    displayNotes(noteSequence);
                    displayAminoAcids(aminoAcidSequence);
                    playBtn.disabled = false;
                    downloadAudioBtn.disabled = false;
                    downloadPdfBtn.disabled = false;
                }
                statusDiv.textContent = statusMsg;
            });
            
            function getScaleNotes(root, type) {
                const rootIndex = notes.indexOf(root);
                if (rootIndex === -1) return [];
                const intervals = scaleIntervals[type];
                return intervals.map(interval => notes[(rootIndex + interval) % 12]);
            }

            function displayNotes(notes) {
                notesOutput.innerHTML = '';
                const MAX_TO_DISPLAY = 500;
                const notesToDisplay = notes.slice(0, MAX_TO_DISPLAY);

                notesToDisplay.forEach((note, index) => {
                    const noteEl = document.createElement('div');
                    noteEl.textContent = note;
                    noteEl.id = `note-${index}`;
                    noteEl.className = 'note bg-slate-200 text-slate-700 font-mono py-1 px-3 rounded-md text-sm';
                    notesOutput.appendChild(noteEl);
                });

                if (notes.length > MAX_TO_DISPLAY) {
                    const moreNotesEl = document.createElement('div');
                    moreNotesEl.textContent = `+ ${notes.length - MAX_TO_DISPLAY} more notes.`;
                    moreNotesEl.className = 'text-slate-500 text-sm w-full text-center mt-2';
                    notesOutput.appendChild(moreNotesEl);
                }
            }
            
            function displayAminoAcids(aminos) {
                aminoAcidOutput.innerHTML = '';
                const MAX_TO_DISPLAY = 500;
                const aminosToDisplay = aminos.slice(0, MAX_TO_DISPLAY);

                aminosToDisplay.forEach((amino, index) => {
                    const aminoEl = document.createElement('div');
                    aminoEl.textContent = amino;
                    aminoEl.id = `amino-${index}`;
                    aminoEl.className = 'amino-acid bg-slate-200 text-slate-700 font-mono py-1 px-3 rounded-md text-sm';
                    aminoAcidOutput.appendChild(aminoEl);
                });

                if (aminos.length > MAX_TO_DISPLAY) {
                    const moreAminosEl = document.createElement('div');
                    moreAminosEl.textContent = `+ ${aminos.length - MAX_TO_DISPLAY} more amino acids.`;
                    moreAminosEl.className = 'text-slate-500 text-sm w-full text-center mt-2';
                    aminoAcidOutput.appendChild(moreAminosEl);
                }
            }

            playBtn.addEventListener('click', async () => {
                 if (noteSequence.length === 0) return;
                await Tone.start();
                initializeSynths();
                
                if (Tone.Transport.state === 'started') {
                    Tone.Transport.stop();
                    Tone.Transport.cancel();
                }
                
                if (synth) synth.dispose();

                const genre = genreSelect.value;
                const style = genreStyles[genre];

                if (style.distortion && style.distortion > 0) {
                    const distortion = new Tone.Distortion(style.distortion).toDestination();
                    synth = new Tone.Synth(style.synthOptions).connect(distortion);
                } else {
                    synth = new Tone.Synth(style.synthOptions).toDestination();
                }

                // Melody Part
                const noteEvents = createRhythmicEvents(noteSequence, style.rhythm);
                melodyPart = new Tone.Part((time, value) => {
                    synth.triggerAttackRelease(value.note, value.duration, time);
                    Tone.Draw.schedule(() => {
                        highlightNote(value.index);
                        highlightAminoAcid(value.index);
                    }, time);
                }, noteEvents).start(0);

                // Drum Part
                if (style.drumPattern) {
                    drumLoop = new Tone.Part((time, value) => {
                        if (value.note === 'C1') kick.triggerAttackRelease('C1', '8n', time);
                        if (value.note === 'C2') snare.triggerAttackRelease('8n', time);
                        if (value.note === 'E2') hihat.triggerAttackRelease('16n', time);
                    }, style.drumPattern).start(0);
                    drumLoop.loop = true;
                    drumLoop.loopEnd = '1m'; // Loop every measure
                }

                const totalDuration = noteEvents.length > 0 ? noteEvents[noteEvents.length - 1].time + Tone.Time(noteEvents[noteEvents.length - 1].duration).toSeconds() : 0;
                Tone.Transport.scheduleOnce((time) => {
                      Tone.Draw.schedule(() => {
                        statusDiv.textContent = "Playback finished.";
                        stopPlayback();
                    }, time);
                }, totalDuration);

                Tone.Transport.start();
                statusDiv.textContent = 'Playing...';
                playBtn.disabled = true;
                stopBtn.disabled = false;
                downloadAudioBtn.disabled = true;
                downloadPdfBtn.disabled = true;
                convertAudioBtn.disabled = true;
            });
            
             stopBtn.addEventListener('click', () => {
                stopPlayback();
                statusDiv.textContent = 'Playback stopped.';
            });
            
            function stopPlayback() {
                 if (Tone.Transport.state === 'started') {
                    Tone.Transport.stop();
                    Tone.Transport.cancel();
                    if (melodyPart) melodyPart.dispose();
                    if (drumLoop) drumLoop.dispose();
                    clearAllHighlights();
                    playBtn.disabled = false;
                    stopBtn.disabled = true;
                    downloadAudioBtn.disabled = noteSequence.length === 0;
                    downloadPdfBtn.disabled = noteSequence.length === 0;
                    convertAudioBtn.disabled = true; // Keep disabled until new download
                }
            }

            function highlightNote(index) {
                document.querySelectorAll('.note.playing').forEach(el => el.classList.remove('playing'));
                const noteEl = document.getElementById(`note-${index}`);
                if (noteEl) noteEl.classList.add('playing');
            }

            function highlightAminoAcid(index) {
                document.querySelectorAll('.amino-acid.playing').forEach(el => el.classList.remove('playing'));
                const aminoEl = document.getElementById(`amino-${index}`);
                if (aminoEl) aminoEl.classList.add('playing');
            }

            function clearAllHighlights() {
                document.querySelectorAll('.note.playing').forEach(el => el.classList.remove('playing'));
                document.querySelectorAll('.amino-acid.playing').forEach(el => el.classList.remove('playing'));
            }

            function createRhythmicEvents(notes, rhythmPattern) {
                let currentTime = 0;
                const events = [];
                let noteIdx = 0;
                let loopIdx = 0;

                while (noteIdx < notes.length && loopIdx < 20000) { 
                    const rhythmIdx = loopIdx % rhythmPattern.length;
                    const duration = rhythmPattern[rhythmIdx];

                    if (duration === null) {
                        currentTime += Tone.Time('16n').toSeconds(); 
                    } else {
                        const note = notes[noteIdx];
                        events.push({
                            time: currentTime,
                            note: note,
                            duration: duration,
                            index: noteIdx
                        });
                        currentTime += Tone.Time(duration).toSeconds();
                        noteIdx++;
                    }
                    loopIdx++;
                }
                return events;
            }
            
            convertAudioBtn.addEventListener('click', () => {
                convertModal.classList.remove('hidden');
            });
            
            modalCancelBtn.addEventListener('click', () => {
                convertModal.classList.add('hidden');
            });

            modalConfirmBtn.addEventListener('click', () => {
                window.open('https://cloudconvert.com/webm-to-mp3', '_blank');
                statusDiv.textContent = "Upload your downloaded file to convert it.";
                convertModal.classList.add('hidden');
            });
            
            downloadAudioBtn.addEventListener('click', async () => {
                if (noteSequence.length === 0) return;

                statusDiv.textContent = 'Starting audio render...';
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                downloadAudioBtn.disabled = true;
                playBtn.disabled = true;
                stopBtn.disabled = true;
                convertAudioBtn.disabled = true;
                
                await new Promise(resolve => setTimeout(resolve, 50));

                let progressInterval;

                try {
                    const recorder = new Tone.Recorder();
                    
                    const MAX_RENDER_NOTES = 400;
                    const notesToRender = noteSequence.slice(0, MAX_RENDER_NOTES);
                    const genre = genreSelect.value;
                    const style = genreStyles[genre];
                    const noteEvents = createRhythmicEvents(notesToRender, style.rhythm);
                    const duration = noteEvents.length > 0 ? noteEvents[noteEvents.length - 1].time + Tone.Time(noteEvents[noteEvents.length - 1].duration).toSeconds() + 2 : 2;

                    // Connect master output to recorder
                    Tone.getDestination().connect(recorder);
                    
                    initializeSynths();
                    
                    // Re-create instruments for this render pass
                    let renderSynth;
                    if (style.distortion && style.distortion > 0) {
                        const distortion = new Tone.Distortion(style.distortion).toDestination();
                        renderSynth = new Tone.Synth(style.synthOptions).connect(distortion);
                    } else {
                        renderSynth = new Tone.Synth(style.synthOptions).toDestination();
                    }

                    const renderMelodyPart = new Tone.Part((time, value) => {
                        renderSynth.triggerAttackRelease(value.note, value.duration, time);
                    }, noteEvents).start(0);

                    let renderDrumLoop;
                    if (style.drumPattern) {
                        renderDrumLoop = new Tone.Part((time, value) => {
                            if (value.note === 'C1') kick.triggerAttackRelease('C1', '8n', time);
                            if (value.note === 'C2') snare.triggerAttackRelease('8n', time);
                            if (value.note === 'E2') hihat.triggerAttackRelease('16n', time);
                        }, style.drumPattern).start(0);
                        renderDrumLoop.loop = true;
                        renderDrumLoop.loopEnd = '1m';
                    }

                    recorder.start();
                    Tone.Transport.start();
                    
                    const startTime = Date.now();
                    statusDiv.textContent = 'Rendering audio...';
                    
                    progressInterval = setInterval(() => {
                        const elapsedTime = (Date.now() - startTime) / 1000;
                        const percentage = Math.min(100, (elapsedTime / duration) * 100);
                        progressBar.style.width = `${percentage}%`;
                        progressText.textContent = `${Math.floor(percentage)}%`;
                    }, 100);

                    setTimeout(async () => {
                        clearInterval(progressInterval);
                        const recording = await recorder.stop();
                        Tone.Transport.stop(true);
                        
                        // Clean up render instruments
                        renderSynth.dispose();
                        renderMelodyPart.dispose();
                        if (renderDrumLoop) renderDrumLoop.dispose();

                        const url = URL.createObjectURL(recording);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'gene_music.webm';
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        statusDiv.textContent = 'WEBM audio downloaded.';
                        progressText.textContent = 'Complete';
                        
                        downloadAudioBtn.disabled = false;
                        playBtn.disabled = false;
                        convertAudioBtn.disabled = false; // Enable convert button
                        
                        setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            progressText.textContent = '';
                        }, 3000);

                    }, duration * 1000);

                } catch (error) {
                    if(progressInterval) clearInterval(progressInterval);
                    statusDiv.textContent = 'Error rendering audio.';
                    console.error("Audio recording failed:", error);
                    downloadAudioBtn.disabled = false;
                    playBtn.disabled = false;
                    progressContainer.classList.add('hidden');
                    progressText.textContent = '';
                }
            });

            downloadPdfBtn.addEventListener('click', () => {
                if (noteSequence.length === 0) return;

                statusDiv.textContent = 'Generating PDF report...';

                try {
                    const doc = new jsPDF();
                    let currentY = 20;
                    const pageMargin = 20;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const usableWidth = pageWidth - (pageMargin * 2);

                    const checkPageEnd = (heightNeeded) => {
                        if (currentY + heightNeeded > doc.internal.pageSize.getHeight() - pageMargin) {
                            doc.addPage();
                            currentY = pageMargin;
                        }
                    };
                    
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Gene to Music Report', pageWidth / 2, currentY, { align: 'center' });
                    currentY += 15;
                    
                    const userName = userNameInput.value.trim() || 'Anonymous';
                    const today = new Date();
                    const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Created by: ${userName}`, pageMargin, currentY);
                    doc.text(`Date: ${dateStr}`, pageWidth - pageMargin, currentY, { align: 'right' });
                    currentY += 8;
                    doc.text('Application by: Carlos David Cruz Hernandez', pageMargin, currentY);
                    currentY += 20;

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Settings', pageMargin, currentY);
                    currentY += 8;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const scaleText = scaleTypeSelect.options[scaleTypeSelect.selectedIndex].text;
                    const rootNoteText = rootNoteSelect.disabled ? 'N/A' : rootNoteSelect.value;
                    const genreText = genreSelect.options[genreSelect.selectedIndex].text;
                    doc.text(`Scale: ${scaleText}`, pageMargin, currentY);
                    doc.text(`Root Note: ${rootNoteText}`, pageMargin + 70, currentY);
                    doc.text(`Genre: ${genreText}`, pageMargin + 140, currentY);
                    currentY += 15;
                    
                    const addTable = (doc, startY) => {
                        let y = startY;
                        checkPageEnd(30);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Codon to Music Conversion Table', pageMargin, y);
                        y += 10;
                        
                        const tableHeaders = ['Codon', 'Amino Acid', 'Note'];
                        const colWidths = [40, 60, 40];
                        let x = pageMargin;

                        const drawTableHeader = () => {
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'bold');
                            x = pageMargin;
                            tableHeaders.forEach((header, i) => {
                                doc.text(header, x, y);
                                x += colWidths[i];
                            });
                            y += 2;
                            doc.setLineWidth(0.5);
                            doc.line(pageMargin, y, pageWidth - pageMargin, y);
                            y += 6;
                        };

                        drawTableHeader();
                        
                        // Build and sort the conversion data
                        const conversionData = Object.keys(codonAminoAcidMap).map(codon => ({
                            codon: codon,
                            amino: codonAminoAcidMap[codon],
                            note: codonNoteMap[codon]
                        }));

                        const noteOrder = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

                        conversionData.sort((a, b) => {
                            if (a.note === null && b.note !== null) return 1;
                            if (a.note !== null && b.note === null) return -1;
                            if (a.note === null && b.note === null) return 0;

                            const pitchA = a.note.slice(0, -1);
                            const octaveA = parseInt(a.note.slice(-1));
                            const pitchB = b.note.slice(0, -1);
                            const octaveB = parseInt(b.note.slice(-1));

                            const indexA = noteOrder.indexOf(pitchA);
                            const indexB = noteOrder.indexOf(pitchB);

                            if (octaveA !== octaveB) return octaveA - octaveB;
                            if (indexA !== indexB) return indexA - indexB;
                            return a.codon.localeCompare(b.codon);
                        });


                        for (const item of conversionData) {
                            checkPageEnd(6);
                            if (y === pageMargin) { 
                                drawTableHeader();
                            }
                            
                            doc.setFontSize(9);
                            doc.setFont('courier', 'normal');

                            const amino = item.amino;
                            const note = item.note || 'Rest';
                            
                            x = pageMargin;
                            doc.text(item.codon, x, y);
                            x += colWidths[0];
                            doc.text(amino, x, y);
                            x += colWidths[1];
                            doc.text(note, x, y);
                            y += 6;
                        }
                        return y;
                    };

                    currentY = addTable(doc, currentY);
                    currentY += 10;

                    const addWrappedText = (title, text) => {
                        checkPageEnd(20);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(title, pageMargin, currentY);
                        currentY += 8;
                        
                        doc.setFontSize(8);
                        doc.setFont('courier', 'normal');
                        const lines = doc.splitTextToSize(text, usableWidth);
                        checkPageEnd(lines.length * 4);
                        doc.text(lines, pageMargin, currentY);
                        currentY += (lines.length * 4) + 10;
                    };

                    addWrappedText('Original DNA Sequence', geneSequenceInput.value);
                    addWrappedText('Resulting Amino Acid Sequence', aminoAcidSequence.join(' '));
                    addWrappedText('Resulting Musical Notes', noteSequence.join(', '));
                    
                    // Add creator support footer
                    checkPageEnd(30);
                    currentY += 10;
                    doc.setLineWidth(0.5);
                    doc.line(pageMargin, currentY, pageWidth - pageMargin, currentY);
                    currentY += 10;

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Please support the creator:', pageWidth / 2, currentY, { align: 'center' });
                    currentY += 7;
                    doc.setFont('helvetica', 'bold');
                    doc.text('Follow on social media: @cdcruzher', pageWidth / 2, currentY, { align: 'center' });
                    
                    doc.save('gene-to-music-report.pdf');
                    statusDiv.textContent = 'PDF report downloaded.';

                } catch (error) {
                    statusDiv.textContent = 'Error generating PDF.';
                    console.error("PDF generation failed:", error);
                }
            });
        });
    </script>
</body>
</html>
